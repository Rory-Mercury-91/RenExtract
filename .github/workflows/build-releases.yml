# .github/workflows/build-releases.yml
name: Build & Release RenExtract

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  actions: read

env:
  RELEASE_NAME: ${{ github.ref_name }}

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller>=5.0
          
          # Installer les dÃ©pendances depuis requirements.txt
          if (Test-Path requirements.txt) {
            echo "ğŸ“¦ Installation depuis requirements.txt"
            pip install -r requirements.txt
          } else {
            echo "âš ï¸  requirements.txt non trouvÃ©, installation manuelle"
            pip install tkinterdnd2>=0.3.0
            pip install requests>=2.0
            pip install groq>=0.4.1
            pip install typing-extensions>=4.0.0
            # Note : Pillow supprimÃ© - utilise maintenant l'installation temporaire des polices
          }
        shell: pwsh

      - name: Build Windows Executable
        run: |
          echo "ğŸ”¨ Construction de RenExtract pour Windows..."
          
          # CrÃ©er les dossiers artifacts
          mkdir artifacts
          mkdir artifacts/windows
          
          # CrÃ©er le dossier 04_Configs s'il n'existe pas (ignorÃ© par Git)
          if (-not (Test-Path "04_Configs")) {
            mkdir "04_Configs"
            echo "ğŸ“ Dossier 04_Configs crÃ©Ã©"
          }
          
          # VÃ©rifier la prÃ©sence de l'icÃ´ne
          if (Test-Path icone.ico) {
            echo "ğŸ¨ IcÃ´ne dÃ©tectÃ©e"
            $iconArg = "--icon=icone.ico"
          } else {
            echo "âš ï¸  IcÃ´ne non trouvÃ©e, compilation sans icÃ´ne"
            $iconArg = ""
          }
          
          # VÃ©rifier la prÃ©sence de version_info.txt
          if (Test-Path version_info.txt) {
            echo "ğŸ“‹ version_info.txt dÃ©tectÃ©"
            $versionInfoArg = "--version-file=version_info.txt"
          } else {
            echo "âš ï¸  version_info.txt non trouvÃ©"
            $versionInfoArg = ""
          }
          
          # CrÃ©er l'exÃ©cutable avec PyInstaller
          # --noupx : DÃ©sactive compression UPX (rÃ©duit faux positifs antivirus)
          # --runtime-tmpdir : Utilise dossier courant au lieu de temp systÃ¨me
          pyinstaller --onefile --windowed `
            --name "RenExtract" `
            --noupx `
            --runtime-tmpdir=. `
            $iconArg `
            $versionInfoArg `
            --add-data "core;core" `
            --add-data "infrastructure;infrastructure" `
            --add-data "ui;ui" `
            --add-data "04_Configs;04_Configs" `
            --hidden-import=groq `
            --hidden-import=typing_extensions `
            main.py
          
          # Copier l'exÃ©cutable
          copy "dist/RenExtract.exe" "artifacts/windows/"
          
          # CrÃ©er l'archive avec un nom descriptif
          $version = "${{ env.RELEASE_NAME }}"
          if (-not $version.StartsWith("v")) {
            $version = "dev-$(Get-Date -Format 'yyyyMMdd')"
          }
          Compress-Archive -Path "artifacts/windows/RenExtract.exe" -DestinationPath "artifacts/windows/RenExtract-$version-Windows.zip"
          
          echo "âœ… Build Windows terminÃ©: RenExtract-$version-Windows.zip"
        shell: pwsh

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ env.RELEASE_NAME }}
          path: artifacts/windows/*.zip
          retention-days: 30

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk python3-dev

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller>=5.0
          
          # Installer les dÃ©pendances depuis requirements.txt
          if [ -f requirements.txt ]; then
            echo "ğŸ“¦ Installation depuis requirements.txt"
            pip install -r requirements.txt
          else
            echo "âš ï¸  requirements.txt non trouvÃ©, installation manuelle"
            pip install tkinterdnd2>=0.3.0
            pip install requests>=2.0
            pip install groq>=0.4.1
            pip install typing-extensions>=4.0.0
            # Note : Pillow supprimÃ© - utilise maintenant l'installation temporaire des polices
          fi

      - name: Build Linux Binary
        run: |
          echo "ğŸ”¨ Construction de RenExtract pour Linux..."
          mkdir -p artifacts/linux
          
          # CrÃ©er le dossier 04_Configs s'il n'existe pas (ignorÃ© par Git)
          if [ ! -d "04_Configs" ]; then
            mkdir -p "04_Configs"
            echo "ğŸ“ Dossier 04_Configs crÃ©Ã©"
          fi
          
          # CrÃ©er l'exÃ©cutable Linux
          # --noupx : DÃ©sactive compression UPX (cohÃ©rence avec Windows)
          pyinstaller --onefile \
            --name "RenExtract" \
            --noupx \
            --add-data "core:core" \
            --add-data "infrastructure:infrastructure" \
            --add-data "ui:ui" \
            --add-data "04_Configs:04_Configs" \
            --hidden-import=groq \
            --hidden-import=typing_extensions \
            main.py
          
          # Copier l'exÃ©cutable
          cp dist/RenExtract artifacts/linux/
          
          # Rendre exÃ©cutable
          chmod +x artifacts/linux/RenExtract
          
          # CrÃ©er l'archive tar.gz
          VERSION="${{ env.RELEASE_NAME }}"
          if [[ ! "$VERSION" =~ ^v ]]; then
            VERSION="dev-$(date +%Y%m%d)"
          fi
          tar -czf artifacts/linux/RenExtract-${VERSION}-Linux.tar.gz -C artifacts/linux RenExtract
          
          echo "âœ… Build Linux terminÃ©: RenExtract-${VERSION}-Linux.tar.gz"

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ env.RELEASE_NAME }}
          path: artifacts/linux/*.tar.gz
          retention-days: 30

  create-release:
    name: Create GitHub Release
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    # Ne crÃ©er une release que pour les tags
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4

      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-${{ env.RELEASE_NAME }}
          path: release/windows

      - name: Download Linux Artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-${{ env.RELEASE_NAME }}
          path: release/linux

      - name: Generate Release Notes
        id: release_notes
        run: |
          VERSION="${{ github.ref_name }}"
          
          cat > release_notes.md << 'EOFNOTES'
          ## ğŸ® RenExtract ${{ github.ref_name }}
          
          **Outil professionnel d'extraction, prÃ©paration et reconstruction de traductions pour Ren'Py**
          
          ---
          
          ### â¬‡ï¸ TÃ©lÃ©chargement Direct
          
          [![Download Windows](https://img.shields.io/badge/Windows-0078D4?style=for-the-badge&logo=windows&logoColor=white)](https://github.com/Rory-Mercury-91/RenExtract/releases/download/${{ github.ref_name }}/RenExtract-${{ github.ref_name }}-Windows.zip)
          [![Download Linux](https://img.shields.io/badge/Linux-FCC624?style=for-the-badge&logo=linux&logoColor=black)](https://github.com/Rory-Mercury-91/RenExtract/releases/download/${{ github.ref_name }}/RenExtract-${{ github.ref_name }}-Linux.tar.gz)
          
          | Plateforme | Taille | TÃ©lÃ©chargement |
          |------------|--------|----------------|
          | ğŸªŸ **Windows** | ![Windows Size](https://img.shields.io/github/downloads/Rory-Mercury-91/RenExtract/${{ github.ref_name }}/RenExtract-${{ github.ref_name }}-Windows.zip?label=%20&style=flat-square) | [RenExtract-${{ github.ref_name }}-Windows.zip](https://github.com/Rory-Mercury-91/RenExtract/releases/download/${{ github.ref_name }}/RenExtract-${{ github.ref_name }}-Windows.zip) |
          | ğŸ§ **Linux** | ![Linux Size](https://img.shields.io/github/downloads/Rory-Mercury-91/RenExtract/${{ github.ref_name }}/RenExtract-${{ github.ref_name }}-Linux.tar.gz?label=%20&style=flat-square) | [RenExtract-${{ github.ref_name }}-Linux.tar.gz](https://github.com/Rory-Mercury-91/RenExtract/releases/download/${{ github.ref_name }}/RenExtract-${{ github.ref_name }}-Linux.tar.gz) |
          
          ---
          
          ### ğŸ“¥ DÃ©tails des TÃ©lÃ©chargements
          
          | Plateforme | Fichier | Instructions |
          |------------|---------|--------------|
          | ğŸªŸ **Windows** | `RenExtract-${{ github.ref_name }}-Windows.zip` | Extraire et exÃ©cuter `RenExtract.exe` |
          | ğŸ§ **Linux** | `RenExtract-${{ github.ref_name }}-Linux.tar.gz` | Extraire, `chmod +x RenExtract`, puis `./RenExtract` |
          
          ### ğŸš€ Installation
          
          **Windows** : Extraire `.zip` â†’ Double-cliquer `RenExtract.exe`  
          **Linux** : `tar -xzf`, `chmod +x RenExtract`, `./RenExtract`
          
          ### âœ¨ FonctionnalitÃ©s Principales
          
          - ğŸ“„ **Extraction & GÃ©nÃ©ration** : Extraction intelligente + gÃ©nÃ©ration Ren'Py (pas besoin du SDK !)
          - ğŸ¤– **Traduction IA Groq** : IntÃ©gration Groq AI avec personnages, contexte et profils personnalisables
          - ğŸŒ **Screen Preferences** : GÃ©nÃ©rateur automatique (police, textbox, langue)
          - ğŸ”§ **Outils AvancÃ©s** : Nettoyage intelligent, cohÃ©rence, sauvegardes hiÃ©rarchiques
          - ğŸ¨ **Interface Moderne** : ThÃ¨mes, tutoriel intÃ©grÃ©, Drag & Drop, Ã©dition temps rÃ©el
          - ğŸ—ï¸ **Architecture MVP** : 114 fichiers Python, 24 packages surveillÃ©s, 100% production-ready
          
          ### ğŸ’¡ Utilisation Rapide
          
          > **Important** : RenExtract ne traduit pas automatiquement ! Il prÃ©pare vos fichiers, vous traduisez avec vos outils prÃ©fÃ©rÃ©s (DeepL, ChatGPT, etc.), puis RenExtract reconstruit les fichiers Ren'Py.
          
          **Workflow** : Charger projet â†’ GÃ©nÃ©rer structure TL â†’ Extraire dialogues â†’ Traduire fichiers `.txt` â†’ Reconstruire â†’ VÃ©rifier cohÃ©rence â†’ Tester in-game
          
          ### ğŸ“š Documentation & Support
          
          - ğŸ“– **README** : https://github.com/Rory-Mercury-91/RenExtract
          - ğŸ“ **Tutoriel intÃ©grÃ©** : Appuyez sur `F1` ou cliquez sur "â“ Guide Complet"
          - ğŸ’¬ **Support Discord** : https://discord.gg/Yp2Hm8JWQ2 (rÃ©ponse rapide !)
          
          ### ğŸ”§ Configuration
          
          **Requis** : Windows 10/11 (64-bit) ou Linux (GTK3+), 4 GB RAM, ~100 MB disque  
          **Conseil** : VÃ©rifiez toujours la cohÃ©rence aprÃ¨s reconstruction des fichiers traduits
          
          ---
          
          ### ğŸ†• NouveautÃ©s ${{ github.ref_name }}
          
          #### ğŸ¯ FonctionnalitÃ©s Principales
          - âœ… **Installation temporaire des polices** : AperÃ§u des polices personnalisÃ©es sans Pillow (-9 MB exÃ©cutable)
          - âœ… **Gestion intelligente des polices** : Conservation des polices utilisÃ©es, nettoyage automatique des autres
          
          #### ğŸ”§ AmÃ©liorations & Corrections
          - âœ… **Optimisation taille exÃ©cutable** : Suppression de Pillow, rÃ©duction de 25 MB Ã  ~16 MB
          - âœ… **Logs optimisÃ©s** : Regroupement et nettoyage des messages de polices
          - âœ… **Code mort supprimÃ©** : -56 lignes dans font_manager.py
          - âœ… **Build configs mises Ã  jour** : requirements.txt, create_windows_exe.py, build-releases.yml
          
          #### ğŸ“– Documentation & Tutoriel
          - âœ… **README simplifiÃ©** : Documentation utilisateur concise sur les faux positifs antivirus
          
          ---
          
          > ğŸ’¡ **Conseil** : Restez concis, le README contient dÃ©jÃ  les dÃ©tails techniques
          
          Consultez le [CHANGELOG](https://github.com/Rory-Mercury-91/RenExtract/blob/main/CHANGELOG.md) pour tous les dÃ©tails.
          
          ---
          
          ğŸ’– **Merci d'utiliser RenExtract !**
          
          ğŸ’¬ **Support** : [Discord](https://discord.gg/Yp2Hm8JWQ2) (rÃ©ponse rapide !)  
          ğŸ› **Bugs** : [GitHub Issues](https://github.com/Rory-Mercury-91/RenExtract/issues)  
          â­ **Aimer** : N'oubliez pas de mettre une Ã©toile sur GitHub !  
          ğŸ¤ **Contribuer** : Les pull requests sont les bienvenues !
          EOFNOTES

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: RenExtract ${{ github.ref_name }}
          files: |
            release/windows/*.zip
            release/linux/*.tar.gz
          body_path: release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
