# .github/workflows/build-releases.yml
name: Build & Release RenExtract

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  actions: read

env:
  RELEASE_NAME: ${{ github.ref_name }}

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller>=5.0
          
          # Installer les dÃ©pendances depuis requirements.txt
          if (Test-Path requirements.txt) {
            echo "ğŸ“¦ Installation depuis requirements.txt"
            pip install -r requirements.txt
          } else {
            echo "âš ï¸  requirements.txt non trouvÃ©, installation manuelle"
            pip install tkinterdnd2>=0.3.0
            pip install requests>=2.0
            pip install groq>=0.4.1
            pip install typing-extensions>=4.0.0
          }
        shell: pwsh

      - name: Build Windows Executable
        run: |
          echo "ğŸ”¨ Construction de RenExtract pour Windows..."
          
          # CrÃ©er les dossiers artifacts
          mkdir artifacts
          mkdir artifacts/windows
          
          # CrÃ©er le dossier 04_Configs s'il n'existe pas (ignorÃ© par Git)
          if (-not (Test-Path "04_Configs")) {
            mkdir "04_Configs"
            echo "ğŸ“ Dossier 04_Configs crÃ©Ã©"
          }
          
          # VÃ©rifier la prÃ©sence de l'icÃ´ne
          if (Test-Path icone.ico) {
            echo "ğŸ¨ IcÃ´ne dÃ©tectÃ©e"
            $iconArg = "--icon=icone.ico"
          } else {
            echo "âš ï¸  IcÃ´ne non trouvÃ©e, compilation sans icÃ´ne"
            $iconArg = ""
          }
          
          # CrÃ©er l'exÃ©cutable avec PyInstaller
          pyinstaller --onefile --windowed `
            --name "RenExtract" `
            $iconArg `
            --add-data "core;core" `
            --add-data "infrastructure;infrastructure" `
            --add-data "ui;ui" `
            --add-data "04_Configs;04_Configs" `
            --hidden-import=groq `
            --hidden-import=typing_extensions `
            main.py
          
          # Copier l'exÃ©cutable
          copy "dist/RenExtract.exe" "artifacts/windows/"
          
          # CrÃ©er l'archive avec un nom descriptif
          $version = "${{ env.RELEASE_NAME }}"
          if (-not $version.StartsWith("v")) {
            $version = "dev-$(Get-Date -Format 'yyyyMMdd')"
          }
          Compress-Archive -Path "artifacts/windows/RenExtract.exe" -DestinationPath "artifacts/windows/RenExtract-$version-Windows.zip"
          
          echo "âœ… Build Windows terminÃ©: RenExtract-$version-Windows.zip"
        shell: pwsh

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ env.RELEASE_NAME }}
          path: artifacts/windows/*.zip
          retention-days: 30

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk python3-dev

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller>=5.0
          
          # Installer les dÃ©pendances depuis requirements.txt
          if [ -f requirements.txt ]; then
            echo "ğŸ“¦ Installation depuis requirements.txt"
            pip install -r requirements.txt
          else
            echo "âš ï¸  requirements.txt non trouvÃ©, installation manuelle"
            pip install tkinterdnd2>=0.3.0
            pip install requests>=2.0
            pip install groq>=0.4.1
            pip install typing-extensions>=4.0.0
          fi

      - name: Build Linux Binary
        run: |
          echo "ğŸ”¨ Construction de RenExtract pour Linux..."
          mkdir -p artifacts/linux
          
          # CrÃ©er le dossier 04_Configs s'il n'existe pas (ignorÃ© par Git)
          if [ ! -d "04_Configs" ]; then
            mkdir -p "04_Configs"
            echo "ğŸ“ Dossier 04_Configs crÃ©Ã©"
          fi
          
          # CrÃ©er l'exÃ©cutable Linux
          pyinstaller --onefile \
            --name "RenExtract" \
            --add-data "core:core" \
            --add-data "infrastructure:infrastructure" \
            --add-data "ui:ui" \
            --add-data "04_Configs:04_Configs" \
            --hidden-import=groq \
            --hidden-import=typing_extensions \
            main.py
          
          # Copier l'exÃ©cutable
          cp dist/RenExtract artifacts/linux/
          
          # Rendre exÃ©cutable
          chmod +x artifacts/linux/RenExtract
          
          # CrÃ©er l'archive tar.gz
          VERSION="${{ env.RELEASE_NAME }}"
          if [[ ! "$VERSION" =~ ^v ]]; then
            VERSION="dev-$(date +%Y%m%d)"
          fi
          tar -czf artifacts/linux/RenExtract-${VERSION}-Linux.tar.gz -C artifacts/linux RenExtract
          
          echo "âœ… Build Linux terminÃ©: RenExtract-${VERSION}-Linux.tar.gz"

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ env.RELEASE_NAME }}
          path: artifacts/linux/*.tar.gz
          retention-days: 30

  create-release:
    name: Create GitHub Release
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    # Ne crÃ©er une release que pour les tags
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4

      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-${{ env.RELEASE_NAME }}
          path: release/windows

      - name: Download Linux Artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-${{ env.RELEASE_NAME }}
          path: release/linux

      - name: Generate Release Notes
        id: release_notes
        run: |
          VERSION="${{ github.ref_name }}"
          
          cat > release_notes.md << 'EOFNOTES'
          ## ğŸ® RenExtract ${{ github.ref_name }}
          
          **Outil professionnel d'extraction, prÃ©paration et reconstruction de traductions pour Ren'Py**
          
          ### ğŸ“¥ TÃ©lÃ©chargements
          
          | Plateforme | Fichier | Instructions |
          |------------|---------|--------------|
          | ğŸªŸ **Windows** | `RenExtract-${{ github.ref_name }}-Windows.zip` | Extraire et exÃ©cuter `RenExtract.exe` |
          | ğŸ§ **Linux** | `RenExtract-${{ github.ref_name }}-Linux.tar.gz` | Extraire, `chmod +x RenExtract`, puis `./RenExtract` |
          
          ### ğŸš€ Installation Rapide
          
          #### Windows
          ```bash
          # 1. TÃ©lÃ©charger RenExtract-${{ github.ref_name }}-Windows.zip
          # 2. Extraire l'archive
          # 3. Double-cliquer sur RenExtract.exe
          ```
          
          #### Linux
          ```bash
          # TÃ©lÃ©charger et extraire
          tar -xzf RenExtract-${{ github.ref_name }}-Linux.tar.gz
          
          # Rendre exÃ©cutable
          chmod +x RenExtract
          
          # ExÃ©cuter
          ./RenExtract
          ```
          
          ### âœ¨ FonctionnalitÃ©s Principales
          
          #### ğŸ¯ Extraction & GÃ©nÃ©ration
          - ğŸ“„ Extraction intelligente des dialogues depuis fichiers `.rpy`
          - ğŸ”§ GÃ©nÃ©ration de fichiers de traduction Ren'Py (pas besoin du SDK !)
          - ğŸ›¡ï¸ Protection automatique des codes spÃ©ciaux et variables
          - ğŸ”„ Reconstruction intelligente des fichiers traduits au format Ren'Py
          - ğŸ“¦ DÃ©compilation des archives `.rpa` et scripts `.rpyc`
          
          #### ğŸ¤– Traduction IA Groq
          - ğŸš€ IntÃ©gration Groq AI pour relecture/amÃ©lioration de traductions
          - âš™ï¸ Personnalisation complÃ¨te du prompt (ton, style, contexte, crÃ©ativitÃ©)
          - ğŸ¯ ModÃ¨le llama-3.3-70b-versatile (75,000 mots/jour gratuit)
          - ğŸ”„ Ã‰diteur temps rÃ©el avec traduction directe
          - ğŸ›¡ï¸ PrÃ©servation automatique des balises Ren'Py
          - ğŸ‘¥ DÃ©finition de personnages pour contexte amÃ©liorÃ©
          - ğŸ“ Profils de prompts personnalisables et rÃ©utilisables
          - ğŸ” Scanner automatique de personnages depuis les fichiers `.rpy`
          - ğŸ“œ Support des dialogues prÃ©cÃ©dents pour contexte conversationnel
          
          #### ğŸŒ Personnalisation AvancÃ©e (Optionnel)
          - ğŸ”§ GÃ©nÃ©rateur screen preferences pour jeux avec structure standard :
            - ğŸ›ï¸ ContrÃ´le taille de police dynamique
            - ğŸ¨ Textbox personnalisÃ© (opacitÃ©, offset, contour)
            - ğŸŒ SÃ©lecteur de langue intÃ©grÃ© au jeu
            - ğŸ¯ DÃ©tection automatique du style Ren'Py
          
          #### ğŸ”§ Outils de Maintenance
          - ğŸ§¹ Nettoyage intelligent des fichiers temporaires
          - ğŸ“Š VÃ©rification de cohÃ©rence avancÃ©e
          - ğŸ’¾ SystÃ¨me de sauvegarde unifiÃ© hiÃ©rarchique avec mÃ©tadonnÃ©es
          - ğŸ“ˆ Rapports HTML dÃ©taillÃ©s
          - ğŸ—„ï¸ Gestionnaire de sauvegardes avec restauration ZIP intelligente
          - ğŸ”„ Synchronisation automatique entre fenÃªtres
          - âš¡ Navigation rapide entre fichiers du projet
          
          #### ğŸ¨ Interface Moderne
          - ğŸ–¼ï¸ Interface graphique intuitive
          - ğŸŒ™ ThÃ¨mes personnalisables
          - ğŸ“– Tutoriel intÃ©grÃ© interactif
          - âš¡ Drag & Drop et copier-coller
          - ğŸ”„ Ã‰dition temps rÃ©el
          
          ### ğŸ—ï¸ Architecture Professionnelle MVP 10/10
          
          - **114 fichiers** Python (core, ui, infrastructure)
          - **24 packages surveillÃ©s** avec systÃ¨me de santÃ©
          - **Logs intelligents** : 1 ligne si OK, dÃ©tails si problÃ¨me
          - **Cache persistant** : Performance optimale multi-session
          - **0 warning** parasite dans les logs
          - **100% production-ready**
          
          ### ğŸ’¡ Utilisation Rapide
          
          > **Important** : RenExtract ne traduit pas automatiquement ! Il prÃ©pare vos fichiers, vous traduisez avec vos outils prÃ©fÃ©rÃ©s (DeepL, ChatGPT, etc.), puis RenExtract reconstruit les fichiers Ren'Py.
          
          1. **Chargez** votre projet Ren'Py
          2. **Ouvrez** l'interface du gÃ©nÃ©rateur
          3. **DÃ©compressez** les `.rpa` et `.rpyc` (si nÃ©cessaire)
          4. **GÃ©nÃ©rez** la structure de fichiers de traduction
          5. **Naviguez** vers le fichier souhaitÃ©
          6. **Extrayez** les dialogues (bouton "âš¡Extraire")
          7. **Traduisez** les fichiers `.txt` avec vos outils
          8. **Reconstruisez** (bouton "ğŸ”§ Reconstruire")
          9. **VÃ©rifiez** la cohÃ©rence (bouton "ğŸ”„ RevÃ©rifier")
          10. **Testez** dans votre jeu !
          
          ### ğŸ“š Documentation ComplÃ¨te
          
          - ğŸ“– **README** : https://github.com/Rory-Mercury-91/RenExtract
          - ğŸ“ **Tutoriel intÃ©grÃ©** : Appuyez sur `F1` dans l'application
          - ğŸ’¬ **Support** : https://github.com/Rory-Mercury-91/RenExtract/issues
          
          ### ğŸ”§ Configuration Requise
          
          - **Windows** : Windows 10/11 (64-bit)
          - **Linux** : Distribution moderne avec GTK3
          - **RAM** : Minimum 4 GB
          - **Disque** : ~100 MB
          
          ### âš ï¸ Notes Importantes
          
          - Les fichiers `.rpy` doivent Ãªtre visibles (RenExtract peut dÃ©compiler `.rpa` et `.rpyc`)
          - RenExtract crÃ©e automatiquement des sauvegardes avant chaque opÃ©ration critique
          - VÃ©rifiez toujours la cohÃ©rence avec le bouton "ğŸ”„ RevÃ©rifier"
          
          ---
          
          ### ğŸ†• NouveautÃ©s v1.2.0
          
          #### ğŸ” Rapport de CohÃ©rence Interactif
          - â˜‘ï¸ **Exclusions interactives** : Marquez les lignes Ã  ignorer directement dans le rapport HTML avec des checkboxes cliquables
          - ğŸŒ **Serveur HTTP local** : Communication temps rÃ©el entre navigateur et application (port dynamique 8000-8099)
          - ğŸ’¾ **Persistence intelligente** : Sauvegarde automatique des exclusions dans `config.json` par projet/fichier/ligne
          - âœ¨ **Feedback visuel** : Animation fade-out et mise Ã  jour instantanÃ©e des Ã©tats (â˜ â†’ âœ“ IgnorÃ©)
          - ğŸ¯ **Labels cliquables** : UX amÃ©liorÃ©e avec "Cliquer pour ignorer" / "âœ“ IgnorÃ©"
          - âš¡ **Cache JavaScript** : Performances optimales avec cache cÃ´tÃ© client (Set)
          - ğŸ–¥ï¸ **Support WSL** : DÃ©tection automatique et binding `0.0.0.0` pour dev Linux/exÃ©cution Windows
          
          #### ğŸ—‚ï¸ Gestionnaire d'Exclusions
          - ğŸªŸ **Interface modale** : FenÃªtre Tkinter thÃ©matisÃ©e avec `ExclusionsManagerDialog`
          - ğŸ“Š **Treeview avancÃ©** : Tableau multi-colonnes (Projet | Fichier | Ligne | Texte | Date) avec tri
          - â˜‘ï¸ **SÃ©lection multiple** : Checkboxes par ligne + header "â˜/â˜‘" pour sÃ©lection globale
          - ğŸ” **Double filtrage** : Filtres dynamiques cascadÃ©s par projet ET par fichier (2 colonnes)
          - ğŸ§  **Filtre intelligent** : Liste de fichiers mise Ã  jour automatiquement selon le projet sÃ©lectionnÃ©
          - ğŸ—‘ï¸ **Suppression batch** : Supprimez plusieurs exclusions en un clic avec feedback progressif
          - ğŸ“ˆ **Statistiques dynamiques** : Compteur avec filtres actifs `ğŸ“Š X exclusion(s) (projet: Y, fichier: Z)`
          - âš™ï¸ **IntÃ©gration seamless** : Accessible depuis l'onglet CohÃ©rence via "âš™ï¸ GÃ©rer les exclusions de lignes"
          
          #### ğŸ¨ Rapport HTML - AmÃ©liorations UX
          - ğŸ”½ **FlÃ¨ches animÃ©es** : Rotation correcte (â†“ â†’ â†‘) lors ouverture/fermeture des sections
          - ğŸ”„ **RÃ©initialiser global** : Un bouton pour rÃ©initialiser tous les filtres ET fermer toutes les sections
          - ğŸ› ï¸ **Corrections CSS/JS** : RÃ©solution erreurs console navigateur + rÃ©organisation scope fonctions
          
          #### ğŸ“– Tutoriel - Professionnalisation Continue
          - âœ… **Tab 03 validÃ©e** : RÃ©vision complÃ¨te de l'onglet Traduction et outils
          - ğŸ¯ **Ton formel maintenu** : Utilisation du "vous" pour cohÃ©rence professionnelle
          - ğŸ“¸ **Images optimisÃ©es** : Structure `tutorial_images/03_main_interface/00X.png`
          - ğŸ—‚ï¸ **Documentation structurÃ©e** : Mise Ã  jour `images_guide.txt` + push vers repo Stockage GitHub
          
          #### ğŸ”§ Corrections Techniques
          - ğŸš¦ **Bouton "Annuler"** : Ã‰tat actif/inactif correct (cohÃ©rence = opÃ©ration non-bloquante)
          - ğŸ“¦ **Gestion imports** : RÃ©solution `ImportError` pour `get_window_manager` lors arrÃªt application
          - ğŸ¨ **AperÃ§u polices custom** : Support Pillow pour rendu correct des polices .ttf/.otf personnalisÃ©es
          - ğŸ§¹ **Nettoyage build** : Suppression `tutorial_images/` du .exe (tÃ©lÃ©chargement GitHub au dÃ©marrage)
          
          Consultez le [CHANGELOG](https://github.com/Rory-Mercury-91/RenExtract/blob/main/CHANGELOG.md) pour tous les dÃ©tails.
          
          ---
          
          ğŸ’– **Merci d'utiliser RenExtract !**
          
          ğŸ› **Bugs** : [Ouvrir une issue](https://github.com/Rory-Mercury-91/RenExtract/issues)  
          â­ **Aimer** : N'oubliez pas de mettre une Ã©toile !  
          ğŸ¤ **Contribuer** : Les pull requests sont les bienvenues !
          EOFNOTES

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: RenExtract ${{ github.ref_name }}
          files: |
            release/windows/*.zip
            release/linux/*.tar.gz
          body_path: release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
