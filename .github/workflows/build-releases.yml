# .github/workflows/build-releases.yml
name: Build & Release RenExtract

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  actions: read

env:
  RELEASE_NAME: ${{ github.ref_name }}

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller>=5.0
          
          # Installer les d√©pendances depuis requirements.txt
          if (Test-Path requirements.txt) {
            echo "üì¶ Installation depuis requirements.txt"
            pip install -r requirements.txt
          } else {
            echo "‚ö†Ô∏è  requirements.txt non trouv√©, installation manuelle"
            pip install tkinterdnd2>=0.3.0
            pip install requests>=2.0
            pip install groq>=0.4.1
            pip install typing-extensions>=4.0.0
            # Note : Pillow supprim√© - utilise maintenant l'installation temporaire des polices
          }
        shell: pwsh

      - name: Update version metadata (anti-detection)
        run: |
          echo "üìù Mise √† jour des m√©tadonn√©es anti-d√©tection..."
          
          # G√©n√©rer une version lisible
          $version = "${{ env.RELEASE_NAME }}"
          if (-not $version.StartsWith("v")) {
            $version = "dev-$(Get-Date -Format 'yyyyMMdd')"
          }
          
          # Mettre √† jour version_info.txt avec le script
          if (Test-Path "Z_Ne_Pas_supprimer/update_version_info.py") {
            python "Z_Ne_Pas_supprimer/update_version_info.py" "RenExtract $version"
            echo "‚úÖ M√©tadonn√©es version_info.txt mises √† jour"
          } else {
            echo "‚ö†Ô∏è  Script update_version_info.py non trouv√©, version_info.txt utilis√© tel quel"
          }
        shell: pwsh

      - name: Build Windows Executable
        run: |
          echo "üî® Construction de RenExtract pour Windows..."
          
          # Cr√©er les dossiers artifacts
          mkdir artifacts
          mkdir artifacts/windows
          
          # Cr√©er le dossier 04_Configs s'il n'existe pas (ignor√© par Git)
          if (-not (Test-Path "04_Configs")) {
            mkdir "04_Configs"
            echo "üìÅ Dossier 04_Configs cr√©√©"
          }
          
          # V√©rifier la pr√©sence de l'ic√¥ne
          if (Test-Path icone.ico) {
            echo "üé® Ic√¥ne d√©tect√©e"
            $iconArg = "--icon=icone.ico"
          } else {
            echo "‚ö†Ô∏è  Ic√¥ne non trouv√©e, compilation sans ic√¥ne"
            $iconArg = ""
          }
          
          # V√©rifier la pr√©sence de version_info.txt
          if (Test-Path version_info.txt) {
            echo "üìã version_info.txt d√©tect√© (avec m√©tadonn√©es anti-d√©tection)"
            $versionInfoArg = "--version-file=version_info.txt"
          } else {
            echo "‚ö†Ô∏è  version_info.txt non trouv√©"
            $versionInfoArg = ""
          }
          
          # Cr√©er l'ex√©cutable avec PyInstaller
          # Options anti-d√©tection :
          # --noupx : D√©sactive compression UPX (r√©duit faux positifs antivirus)
          # --log-level=WARN : Logs propres
          # Imports cach√©s explicites pour √©viter comportements suspects
          pyinstaller --onefile --windowed `
            --name "RenExtract" `
            --noupx `
            --log-level=WARN `
            $iconArg `
            $versionInfoArg `
            --add-data "core;core" `
            --add-data "infrastructure;infrastructure" `
            --add-data "ui;ui" `
            --add-data "04_Configs;04_Configs" `
            --hidden-import=groq `
            --hidden-import=typing_extensions `
            --hidden-import=tkinter `
            --hidden-import=tkinterdnd2 `
            --hidden-import=requests `
            main.py
          
          # Copier l'ex√©cutable
          copy "dist/RenExtract.exe" "artifacts/windows/"
          
          # Cr√©er l'archive avec un nom descriptif
          $version = "${{ env.RELEASE_NAME }}"
          if (-not $version.StartsWith("v")) {
            $version = "dev-$(Get-Date -Format 'yyyyMMdd')"
          }
          Compress-Archive -Path "artifacts/windows/RenExtract.exe" -DestinationPath "artifacts/windows/RenExtract-$version-Windows.zip"
          
          echo "‚úÖ Build Windows termin√©: RenExtract-$version-Windows.zip"
        shell: pwsh

      - name: Generate VirusTotal info
        shell: pwsh
        run: |
          echo "üîê G√©n√©ration des hash pour VirusTotal..."
          
          $exePath = "artifacts/windows/RenExtract.exe"
          $sha256 = (Get-FileHash -Path $exePath -Algorithm SHA256).Hash
          $md5 = (Get-FileHash -Path $exePath -Algorithm MD5).Hash
          
          # Cr√©er le contenu du fichier
          $content = "# VirusTotal Analysis`n`n"
          $content += "Pour v√©rifier la s√©curit√© de cet ex√©cutable:`n`n"
          $content += "1. Visitez: https://www.virustotal.com/`n"
          $content += "2. Uploadez le fichier ou utilisez les hash ci-dessous`n`n"
          $content += "**SHA256:** $sha256`n"
          $content += "**MD5:** $md5`n`n"
          $content += "**Note:** 2-3 d√©tections heuristiques sont normales (faux positifs).`n"
          $content += "Le code source est 100% open source et v√©rifiable sur GitHub.`n`n"
          $content += "**Am√©liorations anti-d√©tection appliqu√©es:**`n"
          $content += "- M√©tadonn√©es compl√®tes (auteur, copyright, licence)`n"
          $content += "- Manifest Windows (pas de droits admin requis)`n"
          $content += "- Options PyInstaller optimis√©es (--noupx, imports explicites)`n"
          $content += "- Lien GitHub visible dans les propri√©t√©s de l'exe`n"
          
          $content | Out-File -FilePath "artifacts/windows/virustotal_info.txt" -Encoding UTF8
          echo "‚úÖ Fichier virustotal_info.txt cr√©√©"

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ env.RELEASE_NAME }}
          path: |
            artifacts/windows/*.zip
            artifacts/windows/virustotal_info.txt
          retention-days: 30

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk python3-dev

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller>=5.0
          
          # Installer les d√©pendances depuis requirements.txt
          if [ -f requirements.txt ]; then
            echo "üì¶ Installation depuis requirements.txt"
            pip install -r requirements.txt
          else
            echo "‚ö†Ô∏è  requirements.txt non trouv√©, installation manuelle"
            pip install tkinterdnd2>=0.3.0
            pip install requests>=2.0
            pip install groq>=0.4.1
            pip install typing-extensions>=4.0.0
            # Note : Pillow supprim√© - utilise maintenant l'installation temporaire des polices
          fi

      - name: Build Linux Binary
        run: |
          echo "üî® Construction de RenExtract pour Linux..."
          mkdir -p artifacts/linux
          
          # Cr√©er le dossier 04_Configs s'il n'existe pas (ignor√© par Git)
          if [ ! -d "04_Configs" ]; then
            mkdir -p "04_Configs"
            echo "üìÅ Dossier 04_Configs cr√©√©"
          fi
          
          # Cr√©er l'ex√©cutable Linux
          # --noupx : D√©sactive compression UPX (coh√©rence avec Windows)
          pyinstaller --onefile \
            --name "RenExtract" \
            --noupx \
            --add-data "core:core" \
            --add-data "infrastructure:infrastructure" \
            --add-data "ui:ui" \
            --add-data "04_Configs:04_Configs" \
            --hidden-import=groq \
            --hidden-import=typing_extensions \
            main.py
          
          # Copier l'ex√©cutable
          cp dist/RenExtract artifacts/linux/
          
          # Rendre ex√©cutable
          chmod +x artifacts/linux/RenExtract
          
          # Cr√©er l'archive tar.gz
          VERSION="${{ env.RELEASE_NAME }}"
          if [[ ! "$VERSION" =~ ^v ]]; then
            VERSION="dev-$(date +%Y%m%d)"
          fi
          tar -czf artifacts/linux/RenExtract-${VERSION}-Linux.tar.gz -C artifacts/linux RenExtract
          
          echo "‚úÖ Build Linux termin√©: RenExtract-${VERSION}-Linux.tar.gz"

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ env.RELEASE_NAME }}
          path: artifacts/linux/*.tar.gz
          retention-days: 30

  create-release:
    name: Create GitHub Release
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    # Ne cr√©er une release que pour les tags
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4

      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-${{ env.RELEASE_NAME }}
          path: release/windows

      - name: Download Linux Artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-${{ env.RELEASE_NAME }}
          path: release/linux

      - name: Generate Release Notes
        id: release_notes
        run: |
          VERSION="${{ github.ref_name }}"
          
          cat > release_notes.md << 'EOFNOTES'
          ## üéÆ RenExtract ${{ github.ref_name }}
          
          **Outil professionnel d'extraction, pr√©paration et reconstruction de traductions pour Ren'Py**
          
          ---
          
          ### ‚¨áÔ∏è T√©l√©chargement Direct
          
          [![Download Windows](https://img.shields.io/badge/Windows-0078D4?style=for-the-badge&logo=windows&logoColor=white)](https://github.com/Rory-Mercury-91/RenExtract/releases/download/${{ github.ref_name }}/RenExtract-${{ github.ref_name }}-Windows.zip)
          [![Download Linux](https://img.shields.io/badge/Linux-FCC624?style=for-the-badge&logo=linux&logoColor=black)](https://github.com/Rory-Mercury-91/RenExtract/releases/download/${{ github.ref_name }}/RenExtract-${{ github.ref_name }}-Linux.tar.gz)
          
          | Plateforme | Taille | T√©l√©chargement |
          |------------|--------|----------------|
          | ü™ü **Windows** | ~16 MB | [RenExtract-${{ github.ref_name }}-Windows.zip](https://github.com/Rory-Mercury-91/RenExtract/releases/download/${{ github.ref_name }}/RenExtract-${{ github.ref_name }}-Windows.zip) |
          | üêß **Linux** | ~18 MB | [RenExtract-${{ github.ref_name }}-Linux.tar.gz](https://github.com/Rory-Mercury-91/RenExtract/releases/download/${{ github.ref_name }}/RenExtract-${{ github.ref_name }}-Linux.tar.gz) |
          
          ---
          
          ### üì• D√©tails des T√©l√©chargements
          
          | Plateforme | Fichier | Instructions |
          |------------|---------|--------------|
          | ü™ü **Windows** | `RenExtract-${{ github.ref_name }}-Windows.zip` | Extraire et ex√©cuter `RenExtract.exe` |
          | üêß **Linux** | `RenExtract-${{ github.ref_name }}-Linux.tar.gz` | Extraire, `chmod +x RenExtract`, puis `./RenExtract` |
          
          ### üöÄ Installation
          
          **Windows** : Extraire `.zip` ‚Üí Double-cliquer `RenExtract.exe`  
          **Linux** : `tar -xzf`, `chmod +x RenExtract`, `./RenExtract`
          
          ### ‚ú® Fonctionnalit√©s Principales
          
          - üìÑ **Extraction & G√©n√©ration** : Extraction intelligente + g√©n√©ration Ren'Py (pas besoin du SDK !)
          - ü§ñ **Traduction IA Groq** : Int√©gration Groq AI avec personnages, contexte et profils personnalisables
          - üåç **Screen Preferences** : G√©n√©rateur automatique (police, textbox, langue)
          - üîß **Outils Avanc√©s** : Nettoyage intelligent, coh√©rence, sauvegardes hi√©rarchiques
          - üé® **Interface Moderne** : Th√®mes, tutoriel int√©gr√©, Drag & Drop, √©dition temps r√©el
          - üèóÔ∏è **Architecture MVP** : 114 fichiers Python, 24 packages surveill√©s, 100% production-ready
          
          ### üí° Utilisation Rapide
          
          > **Important** : RenExtract ne traduit pas automatiquement ! Il pr√©pare vos fichiers, vous traduisez avec vos outils pr√©f√©r√©s (DeepL, ChatGPT, etc.), puis RenExtract reconstruit les fichiers Ren'Py.
          
          **Workflow** : Charger projet ‚Üí G√©n√©rer structure TL ‚Üí Extraire dialogues ‚Üí Traduire fichiers `.txt` ‚Üí Reconstruire ‚Üí V√©rifier coh√©rence ‚Üí Tester in-game
          
          ### üìö Documentation & Support
          
          - üìñ **README** : https://github.com/Rory-Mercury-91/RenExtract
          - üéì **Tutoriel int√©gr√©** : Appuyez sur `F1` ou cliquez sur "‚ùì Guide Complet"
          - üí¨ **Support Discord** : https://discord.gg/Yp2Hm8JWQ2 (r√©ponse rapide !)
          
          ### üîß Configuration
          
          **Requis** : Windows 10/11 (64-bit) ou Linux (GTK3+), 4 GB RAM, ~100 MB disque  
          **Conseil** : V√©rifiez toujours la coh√©rence apr√®s reconstruction des fichiers traduits
          
          ---
          
          ### üÜï Nouveaut√©s ${{ github.ref_name }}
          
          #### üéØ √âdition Coh√©rence en Ligne
          - ‚úÖ **Modification directe depuis rapport HTML** : √âdition des traductions d√©tect√©es avec pr√©-remplissage intelligent
          - ‚úÖ **Surlignage visuel** : Mise en √©vidence des √©l√©ments probl√©matiques dans ANCIEN et NOUVEAU
          - ‚úÖ **Boutons copie** : Copie rapide du texte ANCIEN ou NOUVEAU
          - ‚úÖ **Boutons toggle d'exclusion** : "‚ùå Ignorer / ‚úÖ Inclure" int√©gr√©s dans colonne actions
          - ‚úÖ **Traduction assist√©e** : Int√©gration Groq AI, DeepL, Google, Microsoft, Yandex
          - ‚úÖ **Validation syntaxique Ren'Py** : V√©rification automatique guillemets, crochets, accolades, parenth√®ses
          - ‚úÖ **Backup automatique** : Type `COHERENCE_EDIT` avec sauvegarde avant modification
          
          #### üîß Configuration des √âditeurs
          - ‚úÖ **D√©tection automatique Windows 10/11** : Lecture registre UserChoice pour respecter le choix utilisateur r√©el
          - ‚úÖ **Extraction dynamique des chemins** : R√©cup√©ration chemin d'installation depuis registre (VSCode, Notepad++, Sublime)
          - ‚úÖ **Test de l'√©diteur** : Bouton üß™ cr√©ant fichier test dans `04_Configs` et ouvrant √† ligne 7 pour validation
          - ‚úÖ **Persistance √©diteur personnalis√©** : Synchronisation champ de saisie + combobox
          
          #### üõ°Ô∏è Contr√¥les de Coh√©rence
          - ‚úÖ **Contr√¥le de longueur unifi√©** : Un seul contr√¥le avec seuil 250% et minimum 10 caract√®res
          - ‚úÖ **Guillemets intelligents** : Ignore apostrophes fran√ßaises (c'est, l'eau), compte uniquement quotes r√©elles
          - ‚úÖ **Terminologie fran√ßaise** : ANCIEN/NOUVEAU au lieu de OLD/NEW (√©vite confusion mots-cl√©s Ren'Py)
          - ‚úÖ **Interface optimis√©e** : Grille 4√ó3 (3 lignes de 4 contr√¥les) au lieu de 5-5-2
          - ‚úÖ **12 types de v√©rifications** : Tous configurables et activables/d√©sactivables
          
          #### üîë Test et Validation API
          - ‚úÖ **Test cl√© API Groq** : Bouton üîç dans onglet Application pour tester connexion
          - ‚úÖ **Notifications toast** : Utilisation `notification_manager` pour r√©sultats (succ√®s/erreur)
          - ‚úÖ **Thread s√©par√©** : Test non-bloquant avec d√©sactivation temporaire du bouton
          
          #### üì¶ Optimisation Ex√©cutable
          - ‚úÖ **Suppression Pillow** : R√©duction de 25 MB √† ~16 MB (Windows) / ~18 MB (Linux)
          - ‚úÖ **Installation temporaire polices** : Aper√ßu polices personnalis√©es sans d√©pendance lourde
          - ‚úÖ **Gestion intelligente polices** : Conservation polices utilis√©es, nettoyage temporaires
          
          ---
          
          > üí° **Conseil** : Restez concis, le README contient d√©j√† les d√©tails techniques
          
          Consultez le [CHANGELOG](https://github.com/Rory-Mercury-91/RenExtract/blob/main/CHANGELOG.md) pour tous les d√©tails.
          
          ---
          
          üíñ **Merci d'utiliser RenExtract !**
          
          üí¨ **Support** : [Discord](https://discord.gg/Yp2Hm8JWQ2) (r√©ponse rapide !)  
          üêõ **Bugs** : [GitHub Issues](https://github.com/Rory-Mercury-91/RenExtract/issues)  
          ‚≠ê **Aimer** : N'oubliez pas de mettre une √©toile sur GitHub !  
          ü§ù **Contribuer** : Les pull requests sont les bienvenues !
          EOFNOTES

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: RenExtract ${{ github.ref_name }}
          files: |
            release/windows/*.zip
            release/windows/virustotal_info.txt
            release/linux/*.tar.gz
          body_path: release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          # Utiliser PAT_TOKEN pour permettre de d√©clencher le workflow Discord automatiquement
          # Si PAT_TOKEN n'est pas d√©fini, utilise GITHUB_TOKEN par d√©faut
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
